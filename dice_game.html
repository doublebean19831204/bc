<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¯Œç¿éª°å­é˜µ - åº„å®¶çš„æ•°å­¦é™·é˜±</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: #121212;
            color: white;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #ffcc00;
            margin-bottom: 10px;
        }
        .board {
            background: #222;
            border-radius: 12px;
            padding: 20px;
            max-width: 920px;
            margin: 0 auto;
        }
        .board-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #fff;
        }
        .grid {
            display: grid;
            --tile: 64px;
            grid-template-columns: repeat(9, var(--tile));
            grid-template-rows: repeat(6, var(--tile));
            gap: 6px;
            justify-content: center;
            align-content: center;
            margin: 0 auto 12px;
            padding: 12px;
            background: #111;
            border-radius: 14px;
            border: 1px solid #333;
            position: relative;
        }
        .cell {
            background: #f6f6f6;
            border: 2px solid #0e0e0e;
            border-radius: 10px;
            font-weight: 800;
            color: #0e0e0e;
            cursor: default;
            transition: transform 0.12s ease, filter 0.12s ease, background 0.12s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .cell .num {
            font-size: 18px;
            line-height: 1;
        }
        .cell .prize {
            margin-top: 4px;
            font-size: 12px;
            font-weight: 700;
            color: #ff4757;
            opacity: 0.95;
        }
        .cell.start {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        .cell.start .prize {
            color: #fff;
        }
        .cell.unreachable {
            background: #4b4b4b;
            color: #c7c7c7;
            border-color: #4b4b4b;
        }
        .cell.unreachable .prize {
            color: #d0d0d0;
            opacity: 0.8;
        }
        .cell.landed-trap {
            background: #6b6b6b;
            color: #f3f3f3;
            border-color: #6b6b6b;
            filter: saturate(0.9);
        }
        .cell.landed-trap .prize {
            color: #fff;
            opacity: 0.9;
        }
        .cell.win {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
            transform: translateY(-1px);
        }
        .cell.win .prize {
            color: #fff;
            opacity: 0.95;
        }

        .cell.path {
            outline: 4px solid rgba(255, 204, 0, 0.95);
            outline-offset: -4px;
            filter: brightness(1.02);
        }

        .center-panel {
            grid-column: 2 / span 7;
            grid-row: 2 / span 4;
            background: #000;
            border-radius: 14px;
            border: 1px solid #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
        }
        .wallet {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            background: #0b0b0b;
            border: 1px solid #1e1e1e;
            border-radius: 12px;
        }
        .wallet .summary {
            color: #e9e9e9;
            font-size: 14px;
            line-height: 1.3;
        }
        .wallet .summary b {
            color: #ffcc00;
            font-weight: 800;
        }
        .wallet .hint {
            color: #9b9b9b;
            font-size: 12px;
            margin-top: 2px;
        }
        .wallet button {
            background: #ffcc00;
            color: #111;
            font-weight: 800;
        }
        .wallet button:hover {
            background: #ffd84a;
        }
        .dice-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .die {
            width: 60px;
            height: 60px;
            perspective: 520px;
            display: grid;
            place-items: center;
        }

        /* 3D éª°å­ï¼ˆçº¯ CSSï¼ŒGitHub Pages å¯ç›´æ¥è¿è¡Œï¼‰
           æ ‡å‡†éª°å­ï¼šç›¸å¯¹é¢ç‚¹æ•°ä¹‹å’Œä¸º 7ï¼š1â†”6ã€2â†”5ã€3â†”4
        */
        .cube {
            width: 60px;
            height: 60px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 520ms cubic-bezier(0.2, 0.9, 0.2, 1);
            filter: drop-shadow(0 10px 14px rgba(0, 0, 0, 0.45));
        }
        .cube.rolling {
            transition: transform 650ms cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: rotateX(720deg) rotateY(720deg);
        }
        .face {
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background: linear-gradient(145deg, #ff5a67, #e33948);
            border: 1px solid rgba(255, 255, 255, 0.25);
            display: grid;
            place-items: center;
            backface-visibility: hidden;
        }
                .pips {
                    width: 100%;
                    height: 100%;
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    grid-template-rows: repeat(3, 1fr);
                    padding: 12px;
                    box-sizing: border-box;
                    gap: 6px;
                }
                .pip {
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.95);
                    box-shadow:
                        0 1px 1px rgba(0, 0, 0, 0.25),
                        inset 0 -1px 1px rgba(0, 0, 0, 0.2);
                    justify-self: center;
                    align-self: center;
                }

        .face::after {
            content: "";
            position: absolute;
            inset: 10px;
            border-radius: 10px;
            box-shadow:
                inset 0 2px 8px rgba(0, 0, 0, 0.25),
                inset 0 -2px 10px rgba(255, 255, 255, 0.12);
            pointer-events: none;
        }

        /* å…­ä¸ªé¢çš„ä½ç½® */
        .face.front  { transform: translateZ(30px); }
        .face.back   { transform: rotateY(180deg) translateZ(30px); }
        .face.right  { transform: rotateY(90deg) translateZ(30px); }
        .face.left   { transform: rotateY(-90deg) translateZ(30px); }
        .face.top    { transform: rotateX(90deg) translateZ(30px); }
        .face.bottom { transform: rotateX(-90deg) translateZ(30px); }

          /* æ˜¾ç¤ºå“ªä¸ªç‚¹æ•°åœ¨æ­£é¢ï¼š
              Front=1, Back=6, Right=2, Left=5, Top=3, Bottom=4ï¼ˆç›¸å¯¹é¢å’Œä¸º7ï¼‰
          */
        .cube[data-face="1"] { transform: rotateX(0deg) rotateY(0deg); }
        .cube[data-face="2"] { transform: rotateY(-90deg); }
          /* é¡¶é¢åˆ°æ­£é¢éœ€è¦å‘å‰ç¿»ï¼šrotateX(-90deg) */
          .cube[data-face="3"] { transform: rotateX(-90deg); }
          /* åº•é¢åˆ°æ­£é¢éœ€è¦å‘åç¿»ï¼šrotateX(90deg) */
          .cube[data-face="4"] { transform: rotateX(90deg); }
        .cube[data-face="5"] { transform: rotateY(90deg); }
        .cube[data-face="6"] { transform: rotateY(180deg); }

        @media (prefers-reduced-motion: reduce) {
            .cube, .cube.rolling { transition: none; }
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover {
            background: #ff4757;
        }
        .result {
            margin-top: 12px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            color: #ffcc00;
        }
        .info-panel {
            background: #222;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .info-panel h2 {
            color: #ffcc00;
            margin-top: 0;
        }
        .info-panel ul {
            padding-left: 20px;
        }
        .info-panel li {
            margin: 10px 0;
        }
        .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
        .trap-info {
            color: #ff6b6b;
            font-style: italic;
        }
        .win-info {
            color: #4caf50;
        }
        .current-direction {
            font-size: 1.2em;
            text-align: center;
            margin: 0;
            color: #ffcc00;
        }
        .stats {
            margin-top: 15px;
            font-size: 0.9em;
            color: #aaa;
            text-align: center;
        }

        @media (max-width: 900px) {
            .grid { --tile: 52px; }
            .die { width: 52px; height: 52px; font-size: 22px; }
        }
        @media (max-width: 560px) {
            body { padding: 12px; }
            .grid { --tile: 44px; gap: 5px; padding: 10px; }
            .die { width: 46px; height: 46px; font-size: 20px; }
            button { padding: 9px 14px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ² å¤§å¯Œç¿éª°å­é˜µ â€”â€” åº„å®¶çš„æ•°å­¦é™·é˜±</h1>

        <div class="board">
            <div class="board-title">éª°å­é˜µï¼ˆæ–¹å—æ£‹ç›˜ï¼‰</div>
            <div id="grid" class="grid">
                <div class="center-panel" id="center-panel">
                    <div class="wallet">
                        <div class="summary">
                            <div>ä½™é¢ï¼š<b id="balance">Â¥0</b>ã€€|ã€€å‰©ä½™æ¬¡æ•°ï¼š<b id="plays">0</b></div>
                            <div class="hint">å……å€¼ Â¥100 = 10æ¬¡ï¼ˆæ¯æ¬¡æˆæœ¬ Â¥10ï¼‰</div>
                        </div>
                        <button id="btn-recharge">å……å€¼Â¥100</button>
                    </div>
                    <div class="dice-container" id="dice-container">
                        <!-- éª°å­ä¼šåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="controls">
                        <button id="btn-clockwise">é¡ºæ—¶é’ˆ</button>
                        <button id="btn-counterclockwise">é€†æ—¶é’ˆ</button>
                        <button id="btn-roll">ğŸ² æ‘‡éª°å­</button>
                    </div>
                    <div class="current-direction" id="direction-display">è¯·é€‰æ‹©æ–¹å‘ â†’</div>
                </div>
            </div>
            <div class="result" id="result">ç‚¹å‡»â€œæ‘‡éª°å­â€å¼€å§‹æ¸¸æˆ</div>
            <div class="stats" id="stats">å·²ç©0æ¬¡ | æ€»äºæŸï¼šÂ¥0</div>
        </div>

        <div class="info-panel">
            <h2>ğŸ® æ¸¸æˆè¯´æ˜</h2>
            <p>è¿™æ˜¯ä¸€ä¸ªâ€œçœ‹ä¼¼èƒ½èµ¢ã€å®åˆ™å¿…è¾“â€çš„æ¦‚ç‡é™·é˜±æ¸¸æˆã€‚åº„å®¶æ—©å·²ç®—æ— é—ç­–ã€‚</p>
            
            <h3>ğŸ¯ æ¸¸æˆè§„åˆ™ï¼š</h3>
            <ol>
                <li>é€‰æ‹©â€œé¡ºæ—¶é’ˆâ€æˆ–â€œé€†æ—¶é’ˆâ€ä½œä¸ºä½ çš„ç§»åŠ¨æ–¹å‘</li>
                <li>ç‚¹å‡»â€œæ‘‡éª°å­â€ï¼Œç³»ç»Ÿéšæœºç”Ÿæˆ5ä¸ªéª°å­ç‚¹æ•°</li>
                <li>è®¡ç®—æ€»ç‚¹æ•°ï¼Œä»å¯¹åº”æ•°å­—æ ¼å­å‡ºå‘ï¼Œæ²¿ä½ é€‰çš„æ–¹å‘èµ°ç›¸åº”æ­¥æ•°</li>
                <li>æœ€ç»ˆåœåœ¨å“ªä¸€æ ¼ï¼Œä½ å°±è·å¾—è¯¥æ ¼å¥–é‡‘ï¼ˆæˆ–è½å…¥é™·é˜±ï¼‰</li>
            </ol>

            <h3>âš ï¸ ä¸‰å¤§é™·é˜±æ­ç§˜ï¼š</h3>
            <ul>
                <li><span class="trap-info">é™·é˜±â‘  å•åŒæ•°é™·é˜±</span>ï¼šæ— è®ºä½ é€‰å“ªä¸ªæ–¹å‘ï¼ŒæŸäº›æ ¼å­æ°¸è¿œæ— æ³•åˆ°è¾¾ï¼ˆå¦‚é¡ºæ—¶é’ˆé¿å¼€æ‰€æœ‰å¥‡æ•°æ ¼ï¼‰</li>
                <li><span class="trap-info">é™·é˜±â‘¡ ç»„åˆé™·é˜±</span>ï¼š5ä¸ªéª°å­æœ‰7776ç§ç»„åˆï¼Œå†ä¹˜ä»¥2ç§æ–¹å‘ = 15552ç§å¯èƒ½ï¼Œä¸­å¥–ç‡æä½</li>
                <li><span class="trap-info">é™·é˜±â‘¢ å¤§æ•°å®šå¾‹</span>ï¼šå•æ¬¡æœŸæœ›äºæŸ297å…ƒï¼Œç©10æ¬¡å¹³å‡äº2970å…ƒ â€”â€” ç©å¾—è¶Šå¤šï¼Œè¾“å¾—è¶Šç¨³ï¼</li>
            </ul>

            <h3>ğŸ’° å¥–é‡‘è®¾ç½®ï¼ˆç¤ºä¾‹ï¼‰ï¼š</h3>
            <p>å¤§éƒ¨åˆ†æ ¼å­å¥–é‡‘ä¸º Â¥100~Â¥500ï¼Œä½†æœ‰3ä¸ªâ€œå¤§å¥–æ ¼â€ï¼ˆå¦‚27å·ï¼‰å¯è¾¾ Â¥6000 â€”â€” ä½†ä½ å‡ ä¹ä¸å¯èƒ½èµ°åˆ°ï¼</p>

            <h3>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</h3>
            <p>ç”Ÿæ´»ä¸­å¾ˆå¤šâ€œæ¸¸æˆâ€ï¼ˆå½©ç¥¨ã€æŠ½å¥–ã€é‡‘èäº§å“ï¼‰éƒ½åƒè¿™ä¸ªæ¸¸æˆä¸€æ ·ï¼Œè¡¨é¢è¯±äººï¼Œå®åˆ™è®¾è®¡ç²¾å·§ã€‚è®°ä½ï¼š<span class="highlight">åªè¦å¯¹æ–¹æ•¢è®¾è§„åˆ™ï¼Œå°±ä¸€å®šç®—æ— é—ç­–</span>ã€‚</p>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        // å‚è€ƒæˆªå›¾ï¼šå¤–åœˆä¸ºæ•°å­—æ ¼ï¼Œä¸­é—´ç•™ç™½æ”¾éª°å­
        const boardLayout = [
            [10, 17, 12, 15, 14, 13, 16, 11, 18],
            [19, null, null, null, null, null, null, null, 9],
            [8,  null, null, null, null, null, null, null, 20],
            [21, null, null, null, null, null, null, null, 7],
            [6,  null, null, null, null, null, null, null, 22],
            [23, 30, 25, 28, 27, 26, 29, 24, 5]
        ];

        function buildRing(layout) {
            const rows = layout.length;
            const cols = layout[0].length;
            const ring = [];

            // top row
            for (let c = 0; c < cols; c++) {
                const v = layout[0][c];
                if (v != null) ring.push(v);
            }
            // right column (excluding corners)
            for (let r = 1; r < rows - 1; r++) {
                const v = layout[r][cols - 1];
                if (v != null) ring.push(v);
            }
            // bottom row (right to left)
            for (let c = cols - 1; c >= 0; c--) {
                const v = layout[rows - 1][c];
                if (v != null) ring.push(v);
            }
            // left column (excluding corners, bottom to top)
            for (let r = rows - 2; r >= 1; r--) {
                const v = layout[r][0];
                if (v != null) ring.push(v);
            }

            return ring;
        }

        const flatBoard = buildRing(boardLayout);

        function directionLabel(direction) {
            return direction === 'clockwise' ? 'é¡ºæ—¶é’ˆ' : 'é€†æ—¶é’ˆ';
        }

        function getCellByNum(num) {
            return document.querySelector(`.cell[data-num="${num}"]`);
        }

        // è®¡æ­¥å£å¾„ï¼šèµ·ç‚¹ç®—ç¬¬1æ ¼ã€‚
        // è‹¥æ€»ç‚¹æ•°ä¸º Sï¼Œåˆ™è¡¨ç¤ºâ€œä»èµ·ç‚¹å¼€å§‹æ•°åˆ°ç¬¬ S æ ¼â€ï¼Œå› æ­¤å®é™…ç§»åŠ¨æ­¥æ•°ä¸º (S - 1)ã€‚
        function computePathNums(startNum, steps, direction) {
            const path = [startNum];
            const startIndex = flatBoard.indexOf(startNum);
            if (startIndex === -1) return path;

            const moves = Math.max(steps - 1, 0);
            const len = flatBoard.length;
            let idx = startIndex;
            for (let i = 0; i < moves; i++) {
                idx = direction === 'clockwise'
                    ? (idx + 1) % len
                    : (idx - 1 + len) % len;
                path.push(flatBoard[idx]);
            }
            return path;
        }

        function clearPathHighlight() {
            document.querySelectorAll('.cell.path').forEach(el => el.classList.remove('path'));
        }

        function animatePath(pathNums, onDone) {
            clearPathHighlight();

            // æ¯æ­¥èŠ‚å¥ï¼ˆæ¯«ç§’ï¼‰
            const stepMs = 180;
            let i = 0;

            function tick() {
                if (i > 0) {
                    const prev = getCellByNum(pathNums[i - 1]);
                    if (prev) prev.classList.remove('path');
                }

                const cur = getCellByNum(pathNums[i]);
                if (cur) cur.classList.add('path');

                if (i === pathNums.length - 1) {
                    // ç»ˆç‚¹é«˜äº®ä¿ç•™ï¼šç›´åˆ°ç”¨æˆ·ä¸‹ä¸€æ¬¡ç‚¹å‡»â€œæ‘‡éª°å­â€æ‰æ¸…ç†
                    if (typeof onDone === 'function') onDone();
                    return;
                }

                i++;
                setTimeout(tick, stepMs);
            }

            tick();
        }

        const prizeMap = {
            // æŒ‰æˆªå›¾è®¾ç½®ï¼šæ•°å­—æ ¼å¯¹åº”å¥–é‡‘ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰
            5: 400,
            6: 1400,
            7: 100,
            8: 1200,
            9: 500,
            10: 1000,
            11: 200,
            12: 1200,
            13: 600,
            14: 1000,
            15: 200,
            16: 1200,
            17: 400,
            18: 1000,
            19: 300,
            20: 1400,
            21: 300,
            22: 1000,
            23: 200,
            24: 1400,
            25: 300,
            26: 1200,
            27: -580,
            28: 1600,
            29: 300,
            30: 6000
        };

        let currentDirection = null; // 'clockwise' or 'counterclockwise'
        let totalGames = 0;
        let balance = 0;
        let playsRemaining = 0;
        let totalDeposit = 0;
        let totalNet = 0;

        const COST_PER_PLAY = 10;
        const RECHARGE_AMOUNT = 100;
        const PLAYS_PER_RECHARGE = 10;

        function formatMoney(n) {
            const sign = n < 0 ? '-' : '';
            const abs = Math.abs(Math.round(n));
            return `${sign}Â¥${abs}`;
        }

        function renderWallet() {
            const balanceEl = document.getElementById('balance');
            const playsEl = document.getElementById('plays');
            if (balanceEl) balanceEl.textContent = formatMoney(balance);
            if (playsEl) playsEl.textContent = String(playsRemaining);
        }

        // åˆå§‹åŒ–æ£‹ç›˜
        function initBoard() {
            const grid = document.getElementById('grid');
            const centerPanel = document.getElementById('center-panel');
            grid.innerHTML = '';
            grid.appendChild(centerPanel);

            for (let r = 0; r < boardLayout.length; r++) {
                for (let c = 0; c < boardLayout[r].length; c++) {
                    const num = boardLayout[r][c];
                    if (num == null) continue;

                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.gridRow = String(r + 1);
                    cell.style.gridColumn = String(c + 1);
                    cell.dataset.num = String(num);

                    const numSpan = document.createElement('div');
                    numSpan.className = 'num';
                    numSpan.textContent = String(num);

                    const prize = prizeMap[num] ?? 0;
                    const prizeSpan = document.createElement('div');
                    prizeSpan.className = 'prize';
                    prizeSpan.textContent = prize === 0 ? '' : formatMoney(prize);

                    cell.appendChild(numSpan);
                    cell.appendChild(prizeSpan);
                    grid.appendChild(cell);
                }
            }
        }

        // ç”Ÿæˆéª°å­
        function rollDice() {
            const diceContainer = document.getElementById('dice-container');
            diceContainer.innerHTML = '';
            const diceValues = [];

            function createPips(value) {
                // 3x3 ä½ç½®ç´¢å¼•ï¼ˆ1..9ï¼‰ï¼š
                // 1 2 3
                // 4 5 6
                // 7 8 9
                const positionsByValue = {
                    1: [5],
                    2: [1, 9],
                    3: [1, 5, 9],
                    4: [1, 3, 7, 9],
                    5: [1, 3, 5, 7, 9],
                    6: [1, 3, 4, 6, 7, 9]
                };
                const pos = new Set(positionsByValue[value] || []);
                const pips = document.createElement('div');
                pips.className = 'pips';
                for (let i = 1; i <= 9; i++) {
                    const cell = document.createElement('div');
                    if (pos.has(i)) {
                        const pip = document.createElement('span');
                        pip.className = 'pip';
                        cell.appendChild(pip);
                    }
                    pips.appendChild(cell);
                }
                return pips;
            }

            for (let i = 0; i < 5; i++) {
                const value = Math.floor(Math.random() * 6) + 1;
                diceValues.push(value);
                const die = document.createElement('div');
                die.className = 'die';
                const cube = document.createElement('div');
                cube.className = 'cube rolling';

                // æ ‡å‡†å…­é¢éª°ï¼šç›¸å¯¹é¢å’Œä¸º7ï¼š1â†”6ã€2â†”5ã€3â†”4
                // é¢çš„æ”¾ç½®ï¼šFront=1, Back=6, Right=2, Left=5, Top=3, Bottom=4
                const faces = [
                    { cls: 'front', n: 1 },
                    { cls: 'back', n: 6 },
                    { cls: 'right', n: 2 },
                    { cls: 'left', n: 5 },
                    { cls: 'top', n: 3 },
                    { cls: 'bottom', n: 4 },
                ];
                for (const f of faces) {
                    const face = document.createElement('div');
                    face.className = `face ${f.cls}`;
                    face.setAttribute('aria-label', `ç‚¹æ•° ${f.n}`);
                    face.appendChild(createPips(f.n));
                    cube.appendChild(face);
                }

                // å…ˆæ’­æ”¾æ»šåŠ¨åŠ¨ç”»ï¼Œç¨ååœåœ¨æ­£ç¡®ç‚¹æ•°
                // ç”¨ rAF ç¡®ä¿ DOM å·²æ’å…¥å†è§¦å‘è¿‡æ¸¡
                requestAnimationFrame(() => {
                    cube.dataset.face = String(value);
                    setTimeout(() => cube.classList.remove('rolling'), 80);
                });

                die.appendChild(cube);
                diceContainer.appendChild(die);
            }
            return diceValues;
        }

        // è®¡ç®—è·¯å¾„
        function calculatePath(startNum, steps, direction) {
            // æ‰¾åˆ°èµ·å§‹ä½ç½®ç´¢å¼•
            let startIndex = flatBoard.indexOf(startNum);
            if (startIndex === -1) {
                startIndex = 0; // fallback
            }

            const offset = direction === 'clockwise' ? steps : -steps;
            const len = flatBoard.length;
            const currentIndex = ((startIndex + (offset % len)) % len + len) % len;
            return flatBoard[currentIndex];
        }

        // æ ‡è®°é™·é˜±æ ¼å­
        function markTraps(direction) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const num = parseInt(cell.dataset.num);
                if (direction === 'clockwise' && num % 2 === 1) {
                    cell.classList.add('unreachable');
                } else if (direction === 'counterclockwise' && num % 2 === 0) {
                    cell.classList.add('unreachable');
                } else {
                    cell.classList.remove('unreachable');
                }
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(params) {
            const resultDiv = document.getElementById('result');
            const statsDiv = document.getElementById('stats');

            const {
                startNum,
                finalNum,
                steps,
                direction,
                diceValues,
                prize,
                isTrap,
                pathNums
            } = params;

            const payoutText = isTrap ? 'Â¥0ï¼ˆé™·é˜±ï¼‰' : formatMoney(prize);
            const netThisPlay = (isTrap ? 0 : prize) - COST_PER_PLAY;
            const netColor = netThisPlay >= 0 ? '#4caf50' : '#ff6b6b';

            const diceText = diceValues.join(', ');
            const pathText = pathNums.join(' â†’ ');

            resultDiv.innerHTML = `
                <div>æ–¹å‘ï¼š<strong>${directionLabel(direction)}</strong>ã€€|ã€€éª°å­ï¼š<strong>${diceText}</strong>ã€€|ã€€æ€»ç‚¹æ•°ï¼š<strong>${steps}</strong></div>
                <div style="margin-top:6px;">ä»ç¬¬<strong>${startNum}</strong>æ ¼å¼€å§‹ï¼ˆç®—ç¬¬1æ ¼ï¼‰ï¼Œ${directionLabel(direction)}æ•°åˆ°ç¬¬<strong>${steps}</strong>æ ¼ â†’ åœåœ¨ç¬¬<strong>${finalNum}</strong>æ ¼</div>
                <div style="margin-top:6px; color:#aaa; font-size: 0.95em;">è·¯å¾„ï¼š${pathText}</div>
                <div style="margin-top:10px;">æ´¾å¥–ï¼š<strong>${payoutText}</strong></div>
                <div style="margin-top:6px; color:${netColor}">æœ¬æ¬¡å‡€æ”¶ç›Šï¼š<strong>${formatMoney(netThisPlay)}</strong>ï¼ˆæˆæœ¬ ${formatMoney(COST_PER_PLAY)}ï¼‰</div>
            `;

            statsDiv.textContent = `å·²ç©${totalGames}æ¬¡ | å……å€¼ï¼š${formatMoney(totalDeposit)} | ä½™é¢ï¼š${formatMoney(balance)} | æ€»ç›ˆäºï¼š${formatMoney(totalNet)}`;
        }

        // ä¸»æ¸¸æˆé€»è¾‘
        document.getElementById('btn-clockwise').addEventListener('click', () => {
            currentDirection = 'clockwise';
            document.getElementById('direction-display').textContent = 'å½“å‰æ–¹å‘ï¼šé¡ºæ—¶é’ˆ';
            markTraps(currentDirection);
        });

        document.getElementById('btn-counterclockwise').addEventListener('click', () => {
            currentDirection = 'counterclockwise';
            document.getElementById('direction-display').textContent = 'å½“å‰æ–¹å‘ï¼šé€†æ—¶é’ˆ';
            markTraps(currentDirection);
        });

        document.getElementById('btn-recharge').addEventListener('click', () => {
            balance += RECHARGE_AMOUNT;
            playsRemaining += PLAYS_PER_RECHARGE;
            totalDeposit += RECHARGE_AMOUNT;
            renderWallet();

            const statsDiv = document.getElementById('stats');
            statsDiv.textContent = `å·²ç©${totalGames}æ¬¡ | å……å€¼ï¼š${formatMoney(totalDeposit)} | ä½™é¢ï¼š${formatMoney(balance)} | æ€»ç›ˆäºï¼š${formatMoney(totalNet)}`;
        });

        document.getElementById('btn-roll').addEventListener('click', () => {
            if (!currentDirection) {
                alert('è¯·å…ˆé€‰æ‹©æ–¹å‘ï¼');
                return;
            }

            if (playsRemaining <= 0) {
                alert('å‰©ä½™æ¬¡æ•°ä¸è¶³ï¼Œè¯·å…ˆå……å€¼ Â¥100ï¼ˆè·å¾— 10 æ¬¡ï¼‰');
                return;
            }

            // æ‰£é™¤æœ¬æ¬¡æˆæœ¬
            playsRemaining -= 1;
            balance -= COST_PER_PLAY;

            const diceValues = rollDice();
            const totalSteps = diceValues.reduce((a, b) => a + b, 0);
            const startNum = totalSteps; // ä»æ€»ç‚¹æ•°å¯¹åº”çš„æ ¼å­å¼€å§‹

            // å¦‚æœèµ·å§‹æ ¼ä¸å­˜åœ¨ï¼Œå–æœ€è¿‘çš„
            const validStart = flatBoard.includes(startNum) ? startNum : flatBoard[0];
            
            // èµ°æ ¼é€»è¾‘ï¼šæ‘‡åˆ°å‡ å°±ä»å‡ å¼€å§‹æ•°ï¼›èµ·ç‚¹ç®—ç¬¬1æ ¼ï¼Œæ€»ç‚¹æ•° S è¡¨ç¤ºæ•°åˆ°ç¬¬ S æ ¼ï¼ˆç§»åŠ¨ S-1 æ­¥ï¼‰
            const pathNums = computePathNums(validStart, totalSteps, currentDirection);
            const finalNum = pathNums[pathNums.length - 1];

            // åˆ¤æ–­æ˜¯å¦æ˜¯é™·é˜±æ ¼ï¼ˆæ ¹æ®æ–¹å‘ï¼‰
            let isTrap = false;
            if (currentDirection === 'clockwise' && finalNum % 2 === 1) {
                isTrap = true;
            } else if (currentDirection === 'counterclockwise' && finalNum % 2 === 0) {
                isTrap = true;
            }

            const prize = prizeMap[finalNum] || 0;

            const payout = isTrap ? 0 : prize;
            balance += payout;
            totalGames++;
            totalNet += payout - COST_PER_PLAY;
            renderWallet();

            // é«˜äº®èµ·å§‹æ ¼å’Œç»ˆç‚¹æ ¼
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.classList.remove('start', 'win', 'landed-trap');
                if (parseInt(cell.dataset.num) === validStart) {
                    cell.classList.add('start');
                }
                if (parseInt(cell.dataset.num) === finalNum) {
                    cell.classList.add(isTrap ? 'landed-trap' : 'win');
                }
            });

            showResult({
                startNum: validStart,
                finalNum,
                steps: totalSteps,
                direction: currentDirection,
                diceValues,
                prize,
                isTrap,
                pathNums
            });

            // èµ°æ ¼åŠ¨ç”»ï¼ˆä¸æ”¹å˜æœ€ç»ˆé«˜äº®ï¼Œä»…å±•ç¤ºç§»åŠ¨è¿‡ç¨‹ï¼‰
            animatePath(pathNums);
        });

        // åˆå§‹åŒ–
        window.onload = () => {
            initBoard();
            renderWallet();
        };
    </script>
</body>
</html>
